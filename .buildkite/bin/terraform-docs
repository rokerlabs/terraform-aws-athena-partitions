#!/bin/sh

set -eo pipefail

if ! which git >/dev/null; then
  apk add --update --no-cache git openssh
fi

if [ "$BUILDKITE_BRANCH" == "master" ]; then
  git checkout master
fi

manualDocs=$(sed '/generated-docs-below/q' README.md)
echo "$manualDocs" > README.md

terraform-docs md . >> README.md

printf "\n## Copyright\n\nCopyright (c) 2021 Roker Labs. See [LICENSE](./LICENSE) for details." >> README.md

echo "+++ :git: README changes"
git diff README.md

if [ "$BUILDKITE_BRANCH" == "master" ]; then
  if git status | grep README.md >/dev/null; then
    git add README.md
    git config user.email "rokertech@gmail.com"
    git config user.name "rokerbot"
    git commit -m "docs(README): updated terraform docs"
    git push -u origin master
  fi
fi